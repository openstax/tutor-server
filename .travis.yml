# Copyright 2011-2019 Rice University. Licensed under the Affero General Public
# License version 3 or later.  See the COPYRIGHT file for details.

if: type = pull_request OR branch = master
dist: xenial
language: ruby
addons:
  chrome: stable
  postgresql: 9.6
env:
  global:
    - OXT_DB_USER=postgres
    - OXT_DB_PASS=
    - OXT_TEST_DB=travis_ci_test
    - PARALLEL_TEST_PROCESSORS=2
  matrix:
    - TAG=~speed:fast
    - TAG=speed:fast
    - ASSETS=true
    - LINT=true
rvm: 2.6.1
cache: bundler
before_install:
  - gem install bundler:2.0.1
bundler_args: --without production --retry=6
before_script:
  - bundle exec rake parallel:create parallel:load_schema parallel:seed --trace
script:
  - "[[ -n $LINT ]] && bundle exec rake lint:branch || [[ -z $LINT ]] && true"
  - "[[ -n $ASSETS ]] && bundle exec rake assets:precompile || [[ -z $ASSETS ]] && true"
  - >-
      [[ -n $TAG ]] && bundle exec parallel_rspec ./spec --test-options "--tag $TAG" ||
      [[ -z $TAG ]] && true
